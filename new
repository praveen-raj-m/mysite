generatePrompt() {
  try {
    const lines = this.rawInput.trim().split('\n');
    if (lines.length < 2) {
      this.prompt = 'Invalid table.';
      return;
    }

    const headers = lines[0].split(',').map(h => h.trim());
    const dataLines = lines.slice(1);

    const dataRows = dataLines.map(line => {
      const values = line.split(',').map(v => v.trim());
      const row: any = {};
      headers.forEach((header, index) => {
        row[header] = values[index] || '';
      });
      return row;
    });

    // Remove and store last row (total)
    const totalRow = dataRows.pop()!;

    const lastColumn = headers[headers.length - 1];

    // Sort in descending order by the last column
    dataRows.sort((a, b) => {
      const aVal = parseFloat(a[lastColumn]) || 0;
      const bVal = parseFloat(b[lastColumn]) || 0;
      return bVal - aVal;
    });

    // Tag top 3 and bottom 3
    dataRows.forEach((row, index, arr) => {
      if (index < 3) row['Tag'] = 'Top Performer';
      else if (index >= arr.length - 3) row['Tag'] = 'Underperformer';
    });

    const finalData = [...dataRows];

    // Build a Total object as a separate JSON block
    const totalData: any = {};
    headers.slice(1).forEach(header => {
      totalData[header] = totalRow[header] || '';
    });

    // Combine into final object
    const completeOutput = [
      ...finalData,
      { Total: totalData }
    ];

    const jsonString = JSON.stringify(completeOutput, null, 2);

    this.prompt =
      `You are a financial analyst. Analyze the following portfolio attribution data.\n\n` +
      `The table is sorted by the last column ("${lastColumn}").\n` +
      `The top 3 sectors are marked as "Top Performer", the bottom 3 as "Underperformer".\n` +
      `The last item in the list is the Total row, showing column-wise totals.\n\n` +
      `Data:\n${jsonString}`;
  } catch (err) {
    this.prompt = 'Error parsing input.';
  }
}
